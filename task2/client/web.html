<!DOCTYPE html>
<html lang="vi" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Media Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { height: 100%; margin: 0; display: flex; flex-direction: column; color: white; font-family: 'Inter', sans-serif; }
        #mediaContainer { flex-grow: 1; overflow: auto; background-color: #1a202c; border-radius: 0.5rem; }
        
        /* === ⭐️ SỬA LỖI NẰM Ở ĐÂY ⭐️ === */
        #screenshot, #webcamVideo {
            /* Xóa bỏ width: 100% để tránh ép giãn hình */
            /* width: 100%; */ 
            
            /* Giới hạn media không được lớn hơn khung chứa */
            max-width: 100%;
            max-height: 100%;

            /* Tự động điều chỉnh để giữ tỷ lệ khung hình */
            height: auto;
            width: auto; 
            
            display: none;
        }
        /* ================================ */

        #status.connected { color: #48bb78; } 
        #status.disconnected { color: #f56565; }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col">

    <!-- Header -->
    <header class="flex-shrink-0 mb-4">
        <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">WebSocket Media Viewer</h1>
        <p class="text-gray-400">Trạng thái kết nối: 
            <span id="status" class="font-semibold disconnected">Đang kết nối...</span>
        </p>
    </header>

    <!-- Controls -->
    <div class="flex-shrink-0 mb-4 flex flex-wrap gap-2">
        <button id="captureButton" disabled
            class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 disabled:opacity-50 disabled:cursor-not-allowed">
            Chụp Màn Hình
        </button>
        <button id="webcamButton" disabled
            class="px-5 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 disabled:opacity-50 disabled:cursor-not-allowed">
            Quay Webcam 10s
        </button>
    </div>

    <!-- Media Container -->
    <!-- (Đã thêm class 'overflow-hidden' để đảm bảo không có lỗi tràn) -->
    <div id="mediaContainer" class="flex-grow flex items-center justify-center border-2 border-gray-700 rounded-lg p-2 overflow-hidden">
        <div id="loading" class="text-gray-500" style="display: none;">
            <!-- SVG loading spinner -->
            <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
        <img id="screenshot" alt="Ảnh chụp màn hình từ server">
        <video id="webcamVideo" controls alt="Video webcam từ server"></video>
    </div>

    <script>
        const statusElement = document.getElementById('status');
        const captureButton = document.getElementById('captureButton');
        const webcamButton = document.getElementById('webcamButton');
        const imgElement = document.getElementById('screenshot');
        const videoElement = document.getElementById('webcamVideo');
        const loadingElement = document.getElementById('loading');
        
        let ws;
        let awaitingMedia = null; // 'image' hoặc 'video'

        function connect() {
            ws = new WebSocket('ws://127.0.0.1:8080');

            ws.onopen = () => {
                console.log('Đã kết nối!');
                statusElement.textContent = 'Đã kết nối';
                statusElement.className = 'font-semibold connected';
                captureButton.disabled = false;
                webcamButton.disabled = false;
            };

            ws.onmessage = (event) => {
                if (event.data instanceof Blob) {
                    loadingElement.style.display = 'none';
                    imgElement.style.display = 'none';
                    videoElement.style.display = 'none';

                    if (awaitingMedia === 'image') {
                        // Ảnh thì đơn giản, không cần MIME type
                        const blob = event.data;
                        const url = URL.createObjectURL(blob);
                        imgElement.src = url;
                        imgElement.style.display = 'block';
                        imgElement.onload = () => URL.revokeObjectURL(imgElement.src);

                    } else if (awaitingMedia === 'video') {
                        
                        // Chúng ta phải TẠO LẠI Blob với đúng MIME TYPE.
                        const videoBlob = new Blob([event.data], { type: 'video/webm' });

                        const url = URL.createObjectURL(videoBlob);
                        videoElement.src = url;
                        videoElement.style.display = 'block';
                        videoElement.onload = () => URL.revokeObjectURL(videoElement.src);
                    }
                    awaitingMedia = null; // Đã nhận xong, reset
                }
            };

            ws.onclose = () => {
                console.log('Đã ngắt kết nối.');
                statusElement.textContent = 'Đã ngắt kết nối';
                statusElement.className = 'font-semibold disconnected';
                captureButton.disabled = true;
                webcamButton.disabled = true;
            };

            ws.onerror = (error) => {
                console.error('Lỗi WebSocket:', error);
                statusElement.textContent = 'Lỗi kết nối';
                statusElement.className = 'font-semibold disconnected';
            };
        }

        function showLoading() {
            imgElement.style.display = 'none';
            videoElement.style.display = 'none';
            loadingElement.style.display = 'block';
        }

        captureButton.addEventListener('click', () => {
            if (ws.readyState === WebSocket.OPEN) {
                awaitingMedia = 'image'; // Báo cho onmessage biết chúng ta đang chờ ảnh
                ws.send('SCREENSHOT');
                showLoading();
            }
        });

        webcamButton.addEventListener('click', () => {
            if (ws.readyState === WebSocket.OPEN) {
                awaitingMedia = 'video'; // Báo cho onmessage biết chúng ta đang chờ video
                ws.send('WEBCAM_RECORD_10S');
                showLoading();
            }
        });

        // Tự động kết nối khi tải trang
        connect();
    </script>
</body>
</html>